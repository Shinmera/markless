\definesection{Interpretation}

\warn{This section is unfinished!}

\definesubsection{Parser State}
An \g{implementation} must keep several \gpl{variable} that can be modified by the \g{interpretation}.

\begin{itemize}
\item A \g{document} \g{textual component} where all resulting \g{text} is kept.
\item The \g{position} within the resulting \g{document}.
\item The \g{cursor} within the inputting \g{document}.
\item The \g{line break mode}, defaulting to \inline$unescaped$.
\item A list of \gpl{disabled directive}.
\item A table associating \gpl{label} to \gpl{textual component}. Label names must be \g{case insensitive}.
\item Additionally, it might keep a variety of internal \gpl{variable} that can be changed by an \g{instruction}.
\end{itemize}

\definesubsection{Parser Steps}
When \glink{interpretation}{interpreting} a \g{document} exactly three things can happen to modify the resulting \g{document}:

\begin{itemize}
\item A \g{textual component} is started. This causes a new instance of the component to be inserted at the current \g{position}, the \g{position} to be moved to inside this instance, and the \g{level} to be increased by one.
\item An open \g{textual component} is ended. If this component is not the uppermost, this step is repeated for the \g{current component} until the component to close is the current. The current \g{position} is moved to outside and after the component and the \g{level} is decreased by one.
\item \G{text} is inserted. This means that the \g{text} is inserted at the current \g{position} and the \g{position} is moved to after the inserted \g{text}.
\end{itemize}

When processing the input document, the following steps are taken in order, starting again from the beginning until the \g{document} \g{textual component} is ended.

\begin{enumerate}
\item If the \g{character} at the \g{cursor}'s position is \unicode{5C} then the cursor is advanced by one. If the \g{character} at the new position is not a \g{newline} then it is inserted into the output \g{document} and the \g{cursor} is advanced by one again.
\item If the cursor is at the beginning of a \g{line} or at the beginning of the \g{content binding} of a \g{line directive}:
  \begin{enumerate}
  \item The \g{text} form the \g{cursor}'s position onward is \glink{match}{matched} against every \g{line directive} that is not a \g{disabled directive}, until a match is found.
  \item If a match is found, new \gpl{textual component} are inserted as necessary for the \g{directive} and the \g{resulting textual component} for the \g{directive}, if applicable, is started. Processing is handed over to the \g{directive}.
  \item If no match is found, the processing continues as below.
  \end{enumerate}
\item If the cursor is at the end of a \g{line}:
  \begin{enumerate}
  \item If the \g{line break mode} is \inline$always$, a line break is inserted.
  \item If the \g{line break mode} is \inline$unescaped$ and the \g{character} at the position one before the \g{cursor} is not a \unicode{5C}, a line break is inserted.
  \item If the \g{line break mode} is \inline$escaped$ and the \g{character} at the position one before the \g{cursor} is a \unicode{5C}, a line break is inserted.
  \item If there are any more lines, the \g{cursor} is moved to the beginning of the next \g{line} and processing continues from step 1 again. Otherwise the document parsing is finished and the \g{document} \g{textual component} is ended.
  \end{enumerate}
\item The \g{text} from the \g{cursor}'s position onward is \glink{match}{matched} against every \g{inline directive} that is not a \g{disabled directive}, until a match is found.
\item If a match is found, new \gpl{textual component} are inserted as necessary for the \g{directive} and the \g{resulting textual component} for the \g{directive}, if applicable, is started. Processing is handed over to the \g{directive}.
\item The character at the \g{cursor}'s position is inserted and the \g{cursor} is advanced by one.
\end{enumerate}

% Parsing order
% Labels

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "0-markless"
%%% TeX-engine: luatex
%%% End:
